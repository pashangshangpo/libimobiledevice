name: build-portable

on:
  workflow_dispatch:

jobs:
  build-macOS:
    runs-on: macOS-latest
    steps:
    - name: install build tools
      run: |
          brew install libtool autoconf automake pkgconfig openssl

    - name: setup environment
      run: |
          echo "PREFIX=$HOME/static-deps" >> $GITHUB_ENV
          OPENSSL_PREFIX=$(brew --prefix openssl)
          echo "OPENSSL_PREFIX=$OPENSSL_PREFIX" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$HOME/static-deps/lib/pkgconfig:$OPENSSL_PREFIX/lib/pkgconfig" >> $GITHUB_ENV
          SDKDIR=`xcrun --sdk macosx --show-sdk-path`
          echo "SDKDIR=$SDKDIR" >> $GITHUB_ENV
          USEARCHS=""
          for ARCH in arm64 x86_64; do
            if echo "int main(int argc, char **argv) { return 0; }" | clang -arch $ARCH -o /dev/null -isysroot $SDKDIR -x c - 2>/dev/null; then
              USEARCHS="$USEARCHS -arch $ARCH"
            fi
          done
          echo "USEARCHS=$USEARCHS" >> $GITHUB_ENV
          echo "CFLAGS=$USEARCHS -isysroot $SDKDIR -I$OPENSSL_PREFIX/include" >> $GITHUB_ENV
          echo "LDFLAGS=$USEARCHS -isysroot $SDKDIR -L$OPENSSL_PREFIX/lib" >> $GITHUB_ENV

    - name: build libplist
      run: |
          git clone https://github.com/libimobiledevice/libplist.git
          cd libplist
          ./autogen.sh --enable-static --disable-shared --without-cython \
            --prefix=${{ env.PREFIX }} \
            PKG_CONFIG_PATH=${{ env.PKG_CONFIG_PATH }} \
            CFLAGS="${{ env.CFLAGS }}" \
            LDFLAGS="${{ env.LDFLAGS }}"
          make -j$(sysctl -n hw.ncpu)
          make install

    - name: build libimobiledevice-glue
      run: |
          git clone https://github.com/libimobiledevice/libimobiledevice-glue.git
          cd libimobiledevice-glue
          ./autogen.sh --enable-static --disable-shared \
            --prefix=${{ env.PREFIX }} \
            PKG_CONFIG_PATH=${{ env.PKG_CONFIG_PATH }} \
            CFLAGS="${{ env.CFLAGS }}" \
            LDFLAGS="${{ env.LDFLAGS }}"
          make -j$(sysctl -n hw.ncpu)
          make install

    - name: build libusbmuxd
      run: |
          git clone https://github.com/libimobiledevice/libusbmuxd.git
          cd libusbmuxd
          ./autogen.sh --enable-static --disable-shared \
            --prefix=${{ env.PREFIX }} \
            PKG_CONFIG_PATH=${{ env.PKG_CONFIG_PATH }} \
            CFLAGS="${{ env.CFLAGS }}" \
            LDFLAGS="${{ env.LDFLAGS }}"
          make -j$(sysctl -n hw.ncpu)
          make install

    - name: build libtatsu
      run: |
          git clone https://github.com/libimobiledevice/libtatsu.git
          cd libtatsu
          ./autogen.sh --enable-static --disable-shared \
            --prefix=${{ env.PREFIX }} \
            PKG_CONFIG_PATH=${{ env.PKG_CONFIG_PATH }} \
            CFLAGS="${{ env.CFLAGS }}" \
            LDFLAGS="${{ env.LDFLAGS }}"
          make -j$(sysctl -n hw.ncpu)
          make install

    - name: build libimobiledevice
      run: |
          git clone https://github.com/libimobiledevice/libimobiledevice.git
          cd libimobiledevice
          ./autogen.sh --enable-static --disable-shared --without-cython \
            --prefix=${{ env.PREFIX }} \
            PKG_CONFIG_PATH=${{ env.PKG_CONFIG_PATH }} \
            CFLAGS="${{ env.CFLAGS }}" \
            LDFLAGS="${{ env.LDFLAGS }}"
          make -j$(sysctl -n hw.ncpu)
          make install

    - name: build ideviceinstaller
      run: |
          git clone https://github.com/libimobiledevice/ideviceinstaller.git
          cd ideviceinstaller
          ./autogen.sh --enable-static --disable-shared \
            --prefix=${{ env.PREFIX }} \
            PKG_CONFIG_PATH=${{ env.PKG_CONFIG_PATH }} \
            CFLAGS="${{ env.CFLAGS }}" \
            LDFLAGS="${{ env.LDFLAGS }}"
          make -j$(sysctl -n hw.ncpu)
          make install

    - name: verify binaries
      run: |
          echo "=== 文件列表 ==="
          ls -la ${{ env.PREFIX }}/bin/idevice*
          echo ""
          echo "=== 架构信息 ==="
          file ${{ env.PREFIX }}/bin/idevice_id
          echo ""
          echo "=== 动态库依赖 ==="
          for bin in ${{ env.PREFIX }}/bin/idevice*; do
            echo "--- $(basename $bin) ---"
            otool -L "$bin" | grep -v "$(basename $bin)"
          done

    - name: prepare artifact
      run: |
          mkdir -p release
          cp ${{ env.PREFIX }}/bin/idevice* release/
          rm -f release/*.la 2>/dev/null || true
          ls -la release/

    - name: publish artifact
      uses: actions/upload-artifact@v4
      with:
        name: imobiledevice-macOS-universal
        path: release/

  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        release: false
        update: false
        install: >-
          base-devel
          git
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-openssl
          make
          libtool
          autoconf
          automake-wrapper

    - name: setup environment
      run: |
          echo "PREFIX=$HOME/static-deps" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$HOME/static-deps/lib/pkgconfig" >> $GITHUB_ENV
          git config --global core.autocrlf false

    - name: build libplist
      run: |
          git clone https://github.com/libimobiledevice/libplist.git
          cd libplist
          ./autogen.sh --enable-static --disable-shared --without-cython \
            --prefix=${{ env.PREFIX }} \
            PKG_CONFIG_PATH=${{ env.PKG_CONFIG_PATH }}
          make -j$(nproc)
          make install

    - name: build libimobiledevice-glue
      run: |
          git clone https://github.com/libimobiledevice/libimobiledevice-glue.git
          cd libimobiledevice-glue
          ./autogen.sh --enable-static --disable-shared \
            --prefix=${{ env.PREFIX }} \
            PKG_CONFIG_PATH=${{ env.PKG_CONFIG_PATH }}
          make -j$(nproc)
          make install

    - name: build libusbmuxd
      run: |
          git clone https://github.com/libimobiledevice/libusbmuxd.git
          cd libusbmuxd
          ./autogen.sh --enable-static --disable-shared \
            --prefix=${{ env.PREFIX }} \
            PKG_CONFIG_PATH=${{ env.PKG_CONFIG_PATH }}
          make -j$(nproc)
          make install

    - name: build libtatsu
      run: |
          git clone https://github.com/libimobiledevice/libtatsu.git
          cd libtatsu
          ./autogen.sh --enable-static --disable-shared \
            --prefix=${{ env.PREFIX }} \
            PKG_CONFIG_PATH=${{ env.PKG_CONFIG_PATH }}
          make -j$(nproc)
          make install

    - name: build libimobiledevice
      run: |
          git clone https://github.com/libimobiledevice/libimobiledevice.git
          cd libimobiledevice
          ./autogen.sh --enable-static --disable-shared --without-cython \
            --prefix=${{ env.PREFIX }} \
            PKG_CONFIG_PATH=${{ env.PKG_CONFIG_PATH }} \
            LDFLAGS="-static"
          make -j$(nproc)
          make install

    - name: build ideviceinstaller
      run: |
          git clone https://github.com/libimobiledevice/ideviceinstaller.git
          cd ideviceinstaller
          ./autogen.sh --enable-static --disable-shared \
            --prefix=${{ env.PREFIX }} \
            PKG_CONFIG_PATH=${{ env.PKG_CONFIG_PATH }} \
            LDFLAGS="-static"
          make -j$(nproc)
          make install

    - name: verify binaries
      run: |
          echo "=== 文件列表 ==="
          ls -la ${{ env.PREFIX }}/bin/idevice*
          echo ""
          echo "=== 依赖检查 ==="
          for exe in ${{ env.PREFIX }}/bin/idevice*.exe; do
            echo "--- $(basename $exe) ---"
            ldd "$exe" 2>/dev/null || true
          done

    - name: prepare artifact
      run: |
          mkdir -p release
          cp ${{ env.PREFIX }}/bin/idevice*.exe release/
          ls -la release/

    - name: publish artifact
      uses: actions/upload-artifact@v4
      with:
        name: imobiledevice-windows-x86_64
        path: release/
