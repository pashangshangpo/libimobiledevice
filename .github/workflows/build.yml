name: build-portable

on:
  workflow_dispatch:

jobs:
  build-macOS:
    runs-on: macOS-latest
    steps:
    - name: install dependencies
      run: |
          if test -x "`which port`"; then
            sudo port install libtool autoconf automake pkgconfig
          else
            brew install libtool autoconf automake pkgconfig
          fi
      shell: bash

    - name: fetch libplist
      uses: dawidd6/action-download-artifact@v6
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: build.yml
        name: libplist-latest_macOS
        repo: libimobiledevice/libplist

    - name: fetch libusbmuxd
      uses: dawidd6/action-download-artifact@v6
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: build.yml
        name: libusbmuxd-latest_macOS
        repo: libimobiledevice/libusbmuxd

    - name: fetch libimobiledevice-glue
      uses: dawidd6/action-download-artifact@v6
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: build.yml
        name: libimobiledevice-glue-latest_macOS
        repo: libimobiledevice/libimobiledevice-glue

    - name: fetch libtatsu
      uses: dawidd6/action-download-artifact@v6
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: build.yml
        name: libtatsu-latest_macOS
        repo: libimobiledevice/libtatsu

    - name: install external dependencies
      run: |
          mkdir extract
          for I in *.tar; do
            tar -C extract -xvf $I
          done
          sudo cp -r extract/* /
          
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: install additional requirements
      run: |
          mkdir -p lib
          curl -o lib/libcrypto.35.tbd -Ls \
              https://gist.github.com/nikias/94c99fd145a75a5104415e5117b0cafa/raw/5209dfbff5a871a14272afe4794e76eb4cf6f062/libcrypto.35.tbd
          curl -o lib/libssl.35.tbd -Ls \
              https://gist.github.com/nikias/94c99fd145a75a5104415e5117b0cafa/raw/5209dfbff5a871a14272afe4794e76eb4cf6f062/libssl.35.tbd
          echo "LIBSSL=`pwd`/lib/libssl.35.tbd" >> $GITHUB_ENV
          echo "LIBCRYPTO=`pwd`/lib/libcrypto.35.tbd" >> $GITHUB_ENV
          LIBRESSL_VER=2.2.7
          echo "LIBRESSL_VER=$LIBRESSL_VER" >> $GITHUB_ENV
          FILENAME="libressl-$LIBRESSL_VER.tar.gz"
          curl -o $FILENAME -Ls "https://ftp.openbsd.org/pub/OpenBSD/LibreSSL/$FILENAME"
          mkdir -p deps
          tar -C deps -xzf $FILENAME
          echo "DEPSDIR=`pwd`/deps" >> $GITHUB_ENV

    - name: autogen
      run: |
          SDKDIR=`xcrun --sdk macosx --show-sdk-path`
          TESTARCHS="arm64 x86_64"
          USEARCHS=
          for ARCH in $TESTARCHS; do
            if echo "int main(int argc, char **argv) { return 0; }" |clang -arch $ARCH -o /dev/null -isysroot $SDKDIR -x c - 2>/dev/null; then
              USEARCHS="$USEARCHS -arch $ARCH"
            fi
          done
          export CFLAGS="$USEARCHS -isysroot $SDKDIR"
          echo "Using CFLAGS: $CFLAGS"
          ./autogen.sh PKG_CONFIG_PATH=/usr/local/lib/pkgconfig --enable-debug \
              openssl_CFLAGS="-I${{ env.DEPSDIR }}/libressl-${{ env.LIBRESSL_VER }}/include" \
              openssl_LIBS="-Xlinker ${{ env.LIBSSL }} -Xlinker ${{ env.LIBCRYPTO }}"

    - name: make
      run: make

    - name: make install
      run: sudo make install

    - name: collect and fix binaries
      run: |
          mkdir -p release/bin release/lib

          for f in /usr/local/bin/idevice*; do
            [ -f "$f" ] && cp "$f" release/bin/
          done

          collect_deps() {
            local file="$1"
            otool -L "$file" 2>/dev/null | awk '{print $1}' | while read dep; do
              if [[ "$dep" == /usr/local/lib/* ]]; then
                local name=$(basename "$dep")
                if [ -f "$dep" ] && [ ! -f "release/lib/$name" ]; then
                  cp "$dep" "release/lib/"
                  echo "Collected: $name"
                  collect_deps "release/lib/$name"
                fi
              fi
            done
          }

          for bin in release/bin/*; do
            collect_deps "$bin"
          done
          for lib in release/lib/*.dylib; do
            collect_deps "$lib"
          done

          for bin in release/bin/*; do
            otool -L "$bin" 2>/dev/null | awk '{print $1}' | while read dep; do
              if [[ "$dep" == /usr/local/lib/* ]]; then
                name=$(basename "$dep")
                install_name_tool -change "$dep" "@executable_path/../lib/$name" "$bin"
              fi
            done
          done

          for lib in release/lib/*.dylib; do
            lib_name=$(basename "$lib")
            install_name_tool -id "@loader_path/$lib_name" "$lib" 2>/dev/null || true
            otool -L "$lib" 2>/dev/null | awk '{print $1}' | while read dep; do
              if [[ "$dep" == /usr/local/lib/* ]]; then
                name=$(basename "$dep")
                install_name_tool -change "$dep" "@loader_path/$name" "$lib"
              fi
            done
          done

          for file in release/bin/* release/lib/*.dylib; do
            codesign --force --sign - "$file" 2>/dev/null || true
          done

          echo "=== bin ==="
          ls -la release/bin/
          echo "=== lib ==="
          ls -la release/lib/
          echo "=== idevice_id deps ==="
          otool -L release/bin/idevice_id 2>/dev/null || true
          echo "=== arch ==="
          file release/bin/idevice_id 2>/dev/null || true

    - name: publish artifact
      uses: actions/upload-artifact@v4
      with:
        name: imobiledevice-macOS
        path: release/

  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        release: false
        update: false
        install: >-
          base-devel
          git
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-openssl
          make
          libtool
          autoconf
          automake-wrapper

    - name: prepare environment
      run: |
          dest=`echo MINGW64 |tr [:upper:] [:lower:]`
          echo "dest=$dest" >> $GITHUB_ENV
          echo "target_triplet=`gcc -dumpmachine`" >> $GITHUB_ENV
          git config --global core.autocrlf false

    - name: fetch libplist
      uses: dawidd6/action-download-artifact@v6
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: build.yml
        name: libplist-latest_x86_64-${{ env.dest }}
        repo: libimobiledevice/libplist

    - name: fetch libusbmuxd
      uses: dawidd6/action-download-artifact@v6
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: build.yml
        name: libusbmuxd-latest_x86_64-${{ env.dest }}
        repo: libimobiledevice/libusbmuxd

    - name: fetch libimobiledevice-glue
      uses: dawidd6/action-download-artifact@v6
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: build.yml
        name: libimobiledevice-glue-latest_x86_64-${{ env.dest }}
        repo: libimobiledevice/libimobiledevice-glue

    - name: fetch libtatsu
      uses: dawidd6/action-download-artifact@v6
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: build.yml
        name: libtatsu-latest_x86_64-${{ env.dest }}
        repo: libimobiledevice/libtatsu

    - name: install external dependencies
      run: |
          mkdir extract
          for I in *.tar; do
            tar -C extract -xvf $I
          done
          cp -r extract/* /

    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: autogen
      run: ./autogen.sh CC=gcc CXX=g++ --enable-debug

    - name: make
      run: make

    - name: make install
      run: make install

    - name: collect binaries and dependencies
      run: |
          mkdir -p release

          cp /${{ env.dest }}/bin/idevice*.exe release/ 2>/dev/null || true

          collect_dlls() {
            local file="$1"
            ldd "$file" 2>/dev/null | grep "/${{ env.dest }}/" | awk '{print $3}' | while read dll; do
              local dll_name=$(basename "$dll")
              if [ ! -f "release/$dll_name" ]; then
                cp "$dll" "release/"
                echo "Collected: $dll_name"
                collect_dlls "release/$dll_name"
              fi
            done
          }

          for exe in release/*.exe; do
            collect_dlls "$exe"
          done

          echo "=== 文件列表 ==="
          ls -la release/
          echo "=== idevice_id.exe 依赖 ==="
          ldd release/idevice_id.exe 2>/dev/null || true

    - name: publish artifact
      uses: actions/upload-artifact@v4
      with:
        name: imobiledevice-windows-x86_64
        path: release/
